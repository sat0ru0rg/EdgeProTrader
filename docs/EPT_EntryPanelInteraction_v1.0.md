# EPT_EntryPanelInteraction_v1.0.md

## 第1章. ドキュメントの目的

本ドキュメントは、EdgeProTraderにおける`CEntryPanel`操作仕様と内部ロジック（EntryMode, BE表示, UI制御など）の全体構造を明文化するものである。  
UI設計・内部状態管理・描画制御が一貫して連動する構造を確立し、拡張性と保守性の高いエントリーパネル実装を支援する。

---

## 第2章. EntryMode構成と遷移ルール

- EntryModeは以下の4つで構成される：

  | Mode種別       | 操作対象         | 備考                           |
  |----------------|------------------|--------------------------------|
  | ENTRY_1（0）   | ポジション①       | 最初は固定、以後は選択式          |
  | ENTRY_2（1）   | ポジション②       | 任意に選択可能                  |
  | ENTRY_3（2）   | ポジション③       | ポジ②保有後にエントリー可能になる  |
  | ALL（3）       | 全ポジション       | 保有ポジ数が2つ以上で操作有効     |

- エントリースロットは常に明示的に選択でき、EntryMode切替ボタン列 `[①][②][③][ALL]` を常時表示する

---

## 第3章. UIボタン一覧と操作制御

- すべてのボタンは常時表示し、有効／無効は内部状態に応じて切り替える（Disable表示）

| ボタン名     | ボタン種別 | 有効条件                               | 呼び出し関数              | 備考                                 |
|--------------|-------------|------------------------------------------|---------------------------|--------------------------------------|
| BUY / SELL   | 実行       | SL表示中かつ指定スロット未保有時           | `ExecuteEntry()`          | ポジ1〜3モード時のみ有効             |
| SL_BUY/SELL  | 表示       | EntryMode対象にSLを設定可能な時            | `ShowSLLine()`            | 保有前でも可                         |
| TP_BUY/SELL  | 表示       | SLが表示されている時                      | `ShowTPLine()`            | 保有前でも可                         |
| BE_LINE      | 表示       | 個別モード：保有中<br>ALLモード：保有数≥2時 | `ShowBE_Line()`           | モードによってラインの種類が変化     |
| CLOSE        | 実行       | 対象スロットが保有中                     | `ClosePosition(entryMode)`| 個別決済                            |
| ALL_CLOSE    | 実行       | EntryMode=ALLかつ保有数≥2               | `CloseAllPositions()`     | 一括決済                            |

---

## 第4章. ライン表示制御仕様

### 4.1 通常モード（ENTRY_1〜3）

- 選択中スロットの ENTRY/SL/TP/BE_LINE は太さ2・通常色・操作可
- 他ポジションは ENTRY/SL/TPを薄色・太さ1・操作不可で表示（目視のみ）

### 4.2 ALLモード（BE_LINE非表示）

- すべてのポジションの ENTRY/SL/TP ラインを太さ2・通常色で表示（比較しやすさ重視）
- BE_LINEは非表示（明示操作でのみ表示可）

### 4.3 ALLモード（BE_LINE表示中）

- BE_LINE_ALL（加重平均）を太さ2・白色で表示
- その他全ポジションのラインは薄色・太さ1・操作不可に切り替え

---

## 第5章. BE_LINE_ALLに関する制約と将来構想

- BE_LINE_ALL は EntryMode=ALLかつボタン押下時にのみ表示される
- 本バージョンでは SLへの自動反映やBE一括移動は実装しない
- 将来的には以下の拡張を検討可能：
  - BE_LINE_ALL のドラッグ操作による全SL一括移動
  - 「全ポジ建値へSL統一」ボタンの追加
  - BE制御の有効／無効を設定可能にする

---

## 第6章. CPanelStateManagerとの連携関数一覧（抜粋）

| 関数名                      | 概要                                  |
|-----------------------------|---------------------------------------|
| `GetCurrentEntryMode()`     | 現在のEntryModeを取得                  |
| `HasOpenPosition(index)`    | 指定スロットのポジション保有判定       |
| `GetOpenPositionCount()`    | 現在保有しているポジション数を返す     |
| `CanShowBE_AllMode()`       | ALLモードでBE_LINE_ALLが有効か         |
| `CanEnterInCurrentMode()`   | 現在のEntryModeでエントリー可能か       |
| `SuggestEntryMode()`        | 空いている最小スロットを初期選択値として提案する |

---

以上
