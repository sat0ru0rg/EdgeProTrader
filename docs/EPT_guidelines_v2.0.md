# EdgeProTrader ガイドライン v2.0（統合版ドラフト）

---

## 第1章. ガイドの目的と適用範囲

このドキュメントは、EdgeProTrader プロジェクトにおける以下2領域のルールを統合した運用ガイドラインです：

- **コーディングガイドライン（Coding Guidelines）**
- **プロジェクトファイル管理ガイドライン（PFM: Project File Management）**

本ガイドの目的は以下のとおりです：

- 各担当者が共通認識をもって作業を行うための基準を定義する
- チーム内での設計・保守・レビューの整合性を高める
- 将来的な移植（MQL5等）や拡張性のある運用を可能にする

### 1.1 適用対象

- MQL4で開発されるすべての `Experts/` `Include/` 以下のソース群
- `Common/CommonDefs.mqh` 等の共通モジュール
- Gitで管理される設計・運用ドキュメント群（`.md` ファイル）

### 1.2 管理方針

- バージョンは章構造や内容の大幅更新時に明示的に上げる
- 軽微な記述修正は `EPT_ChangeLog.md` に追記することで対応
- GPT支援による出力構造は `EPT_prompt_v5.0.md` に準拠する

### 1.3 Git運用方針

本プロジェクトにおける Gitブランチ操作・Pull Request・mainブランチ運用などのルールは、  
別途 `EPT_GitFlow_Guide.md` にて標準化されています。必ず当該ガイドに従って操作してください。


---

## 第2章. ガイド構成と分類

本ガイドは、以下2系統のガイドを統合しています：

| 分類 | 内容 | 担当対象 | 補足 |
|------|------|-----------|------|
| コーディングガイドライン | DebugPrint, 命名規則, 関数設計方針 など | 主にMQLソース担当 | `EPT_codingGuide_v1.3` 由来 |
| プロジェクトファイル管理（PFM） | ディレクトリ構成, ファイル命名, バージョン付与 など | 設計者・保守者共通 | `EPT_PFMGuideline_v1.3` 由来 |

> 🔖 どちらも `EPT_prompt_v5.0.md` および `EPT_operationalGuide_v2.0.md` と整合性を保って運用されます。

---

## 第3章. 実装ルール（Coding Guidelines）

### 3.1 デバッグ出力規約（LOGマクロの統一構造）

本プロジェクトでは、すべてのログ出力は `LOG_<カテゴリ>_<レベル>_C()` 形式のマクロによって行い、**クラス名・関数名は `__FUNCTION__` により自動的に出力される構成**とします。旧 `DebugPrint()` は廃止対象とし、今後の開発では使用禁止とします。

#### ✅ マクロ構文

```mql4
LOG_LOGIC_DEBUG_C("スプレッド条件チェック開始");
LOG_ACTION_INFO_C("建値移動完了 Ticket=123456");
LOG_VIEW_ERROR_C("TPライン描画失敗 → objName: TP_1");
```

#### ✅ 出力フォーマット例

ログ出力は以下のような形式となります：

```
[ACTION][ERROR] CEntryExecutor::ExecuteEntry ロット計算失敗
[LOGIC][DEBUG] CEntryExecutor::CheckSpread スプレッド条件チェック開始
[VIEW][ERROR] CChartDrawer::DrawTPLine TPライン描画失敗 → objName: TP_1
```

- カテゴリ・レベル・クラス名・関数名は自動的に付与されます。
- **関数名を明示的に指定する形式（例：LOG_ACTION_ERROR_C("ExecuteEntry", "...")）は使用しません。**

#### ✅ 使用ルール

- ログは「カテゴリ」と「レベル」の2軸で分類される
  - カテゴリ：`VIEW`, `LOGIC`, `ACTION`, `TEST`
  - レベル　：`DEBUG`, `INFO`, `ERROR`
- マクロ定義は `EPT_EnvConfig.mqh` にて提供される（12種）
- ログレベルの選択基準は `EPT_logRule_Draft_v1.3.md` 第4章を参照
- クラス／関数単位で一貫したカテゴリを使用し、粒度の明確な出力を行う
- **クラス名・関数名は `__FUNCTION__` から自動取得されるため、マクロ呼び出し時に明示的に指定しないこと**

#### ✅ 移行方針

- 既存の `DebugPrint()` は段階的に `LOG_◯◯_◯◯_C()` に差し替える
- マクロは `DebugMode` フラグにより全体出力を制御可能

> 🔗 詳細な分類・判定基準・使用例は `EPT_logRule_Draft_v1.3.md` に準拠。

### 3.2 コード例記載方針

- ガイドライン内でのコード提示は、**良い例／悪い例** をセットで記述すること
- 必要に応じて「設計者コメント」「注意点」などの補足も明記する
- 表形式・構文ブロックなどを使い、視認性を高める

### 3.3 クラスファイルの命名規則（正式ルール）

- 各 `.mqh` ファイルには、**1クラスのみを定義することを原則とする**。
- ファイル名は、**定義するクラスと同じ名称（`C〇〇.mqh`）とする**。
- 例：
  - クラス名：`CEntryExecutor` → ファイル名：`CEntryExecutor.mqh`
  - クラス名：`CBEExecutor`    → ファイル名：`CBEExecutor.mqh`

> この命名整合性により、設計のトレース性とIDEでの検索性が大幅に向上する。

### 3.4 テストファイルの命名・設計ガイドライン

#### 📌 ファイル命名ポリシー

- テストファイルは必ず `Test_` を接頭辞に含める。
- 対象となるクラス／機能名と、用途・粒度に応じた接尾辞を組み合わせる：
  - 例：`Test_CEntryValidator.mq4`、`Test_CPanelState_UseCase.mq4`

#### 📌 配置ポリシー

- テストは粒度に応じて以下に分類・配置：

| カテゴリ       | 配置先                                 |
|----------------|------------------------------------------|
| 単体テスト     | `/Experts/Testing/Unit/<カテゴリ名>/`    |
| 統合テスト     | `/Experts/Testing/UseCase/`              |
| 初期化テスト   | `/Experts/Testing/Bootstrap/`            |
| スイート管理   | `/Experts/Testing/Runner/`               |

#### 📌 その他ルール

- `.ex4` はバージョン管理対象外（`.gitignore`）。
- テスト用ヘルパー／モックは `/Include/TestHelpers/` に集約。
- テストファイルには `@TestPurpose:` コメントで目的を明記することを推奨。

> 💡 すべての実装例・詳細構成は `README_Testing.md` にて解説。

### 3.5 テスト実行形式の使い分け（Experts vs Scripts）

テストコードの実行形式には以下の2種類があり、**目的や環境に応じて適切に使い分ける**必要があります。

| 実行形式       | 配置ディレクトリ         | 主な用途・特徴                                     |
|----------------|--------------------------|--------------------------------------------------|
| **Expert形式** | `/Experts/Testing/`       | - 実行順や構成制御が柔軟<br>- モック利用やスイート形式との連携に適す |
| **Script形式** | `/Scripts/Testing/`       | - デモ口座などでの**即時・簡易実行**<br>- `OnStart()` により起動が容易 |

#### ✅ 運用ルール

- 通常の構成確認やモックテストでは **Expert形式** を推奨
- 実運用下での挙動確認や**素早い1ケース検証**では Script形式が便利
- 同じテスト名で両形式を併用することも可能（例：`Test_CEntryExecutor.mq4`）

> 🔗 テスト構成や用途の詳細は `README_Testing.md` および `README_ScriptsTesting.md` を参照。


#### 3.6 推奨ログ出力マクロ（クラス名＋関数名は自動付与）

ログ出力は、**クラス名と関数名が `__FUNCTION__` により自動的に付与されるフォーマット**で統一してください。具体的には以下のログマクロ（`LOG_***_C()`）を使用します：

```mql4
#define __CLASS__ "CEntryExecutor"  // ← 各クラス先頭で定義が必要

LOG_ACTION_INFO_C("エントリー処理を開始します");
LOG_LOGIC_DEBUG_C("内部状態の確認ログです");
LOG_VIEW_ERROR_C("描画に失敗しました");
```

##### 📌 注意事項
- `__CLASS__` は `#define` によりクラスごとに明示してください。
- `__FUNCTION__` は MQL4 標準マクロで現在の関数名を自動取得します。
- **関数名を明示的に指定する形式（例：LOG_ACTION_ERROR_C("ExecuteEntry", "...")）は使用禁止です。**

#### 3.7 非推奨マクロと移行方針

従来使用されていた以下のマクロ群は **非推奨（Deprecated）** とし、順次廃止対象とします：

```mql4
LOG_ACTION_INFO("...");
LOG_LOGIC_ERROR("...");
LOG_TEST_DEBUG("...");
```

今後の全コーディングでは `LOG_***_C()` の使用を原則とし、**既存コードも修正の機会に合わせて置換**していくことを推奨します。


#### 3.8 命名規則ガイド（正式版）

##### 📘▶ プレフィックスルール

| クラス種別        | プレフィックス         | 命名例                                     |
| ------------ | --------------- | --------------------------------------- |
| 業務ロジッククラス    | `C`付き           | `CEntryController`, `CEntryExecutor`    |
| View描画クラス    | `C`付き           | `CPipsLabelVisualizer`                  |
| インタフェース      | `I`付き           | `IEntryExecutor`                        |
| UI/Mediator系 | 無し              | `EntryMediator`, `EntryPanelController` |
| テスト／モック      | `Test_`／`Mock_` | `Test_CEntryValidator`                  |

##### 📗▶ サフィックス（責務識別）

* `Controller`, `Executor`, `Manager`, `Service`, `Visualizer`, `Rules`, `State`, `Calculator` などを**必ず末尾に明示**して責務を示す。

##### 📙▶ ファイル名との対応

* クラス名とファイル名は完全一致とする（例：`CEntryController.mqh`）
* 命名は PascalCase を採用し、構造と責務が一目で分かるようにする。

---

このテンプレートは `EPT_Class_v2.0.md` に統合可能な構造を想定しており、命名規則・責務分離の原則を準拠している。





---

## 第4章. 補足・備考

- 本ガイドラインは `EPT_guidelines_v1.0.md` をベースに再編されたものであり、内容はテンプレ構造に従って再構成されている。
- `EPT_guidelines_Template.md` に基づき、今後も必要に応じて章の増減・再編が可能である。
- GPTによる補助出力やルール自動生成は `EPT_prompt_v5.0.md` を参照のこと。

---

## 第5章. 今後の拡張方針（任意）

- コード整形ルールやリントツールの導入（外部スクリプトによるフォーマット統一）
- PFM領域のGit自動構成ファイル生成（例：`.gitattributes`, `.editorconfig`）
- GPTとの対話ログを活用したプロンプト生成・レビュー履歴の自動化
- MQL5向けルールセットの別ファイル分離・共通ルール抽出

---